<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>⏳ TDTD</title>
<meta name="viewport" content="width=400, initial-scale=1">
<style>
:root {
  --bg: #fafbfc;
  --box: #fff;
  --text: #1a1a1a;
  --accent: #0d7ae6;
  --border: #e0e0e0;
  --muted: #b0b0b0;
  --done: #98c379;
  --low: #4caf50;
  --med: #fbc02d;
  --high: #e53935;
  --tag: #e0e7ef;
}
body.dark {
  --bg: #181c1f;
  --box: #22272a;
  --text: #f0f2f6;
  --accent: #60aaff;
  --border: #33383d;
  --muted: #7d8a93;
  --done: #60a977;
  --tag: #313944;
}
body {
  margin: 0;
  padding: 0;
  font-family: system-ui,sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
}
.appbar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 0.5rem 1rem; background: var(--box); border-bottom: 1px solid var(--border);
  position: sticky; top: 0; z-index: 10;
}
h1 { font-size: 1.2rem; margin: 0; }
button, input, select {
  font-family: inherit; font-size: 1rem; border-radius: 6px;
  border: 1px solid var(--border); padding: 0.4em 0.8em;
}
button { cursor: pointer; border: none; background: var(--accent); color: #fff; }
button[disabled] { opacity: 0.6; pointer-events: none;}
input[type="text"] { width: 100%; background: var(--box); color: var(--text);}
.main {
  max-width: 430px; margin: 2em auto 0 auto; background: var(--box); border-radius: 14px;
  box-shadow: 0 6px 24px #0002; padding: 1.2em 1em 1em 1em;
}
section { margin-bottom: 1em;}
.box-title { font-weight: 600; margin-bottom: 0.5em; }
.box {
  background: var(--bg); border-radius: 9px; padding: 0.6em 0.5em; min-height: 44px;
  border: 1px solid var(--border); margin-bottom: 0.5em; display: flex; flex-direction: column; gap: 0.5em;
}
.active-box { min-height: 65px; justify-content: center;}
#list, #cleared { min-height: 40px;}
.todo {
  display: flex; align-items: center; gap: 0.7em;
  padding: 0.32em 0.3em; border-radius: 7px; background: var(--box);
  border: 1px solid var(--border); font-size: 1rem; transition: box-shadow 0.2s;
  box-shadow: 0 2px 8px #0001;
}
.todo.done { opacity: 0.67; text-decoration: line-through; color: var(--muted); background: var(--box);}
.todo[data-prio="1"] .prio { background: var(--low);}
.todo[data-prio="2"] .prio { background: var(--med);}
.todo[data-prio="3"] .prio { background: var(--high);}
.todo .prio {
  display: inline-block; width: 14px; height: 14px; border-radius: 3px;
  background: var(--muted); margin-right: 2px;
  vertical-align: middle; cursor: pointer; border: 1.5px solid #fff3;
}
.todo input[type=checkbox] { margin: 0; }
.todo .desc { flex: 1 1 auto; }
.todo .tags { margin-left: 0.6em;}
.todo .tag {
  display: inline-block; background: var(--tag); color: var(--text); padding: 0 7px; border-radius: 3px;
  font-size: 0.84em; margin-right: 4px; opacity: 0.8;
}
.todo .actions { display: flex; gap: 5px;}
.todo .edit { cursor: pointer; opacity: 0.6;}
.todo .delete { cursor: pointer; color: #e53935; opacity: 0.7;}
.todo .time { font-size: 0.93em; color: var(--accent); font-weight: 500; margin-left: 8px;}
input[type="text"].edit { background: var(--box); border: 1px solid var(--accent);}
.add-bar {
  display: flex; margin-top: 0.7em; gap: 0.3em;
}
.add-bar input { flex: 1 1 auto;}
#cleared-tab-btn { margin-left: 8px; font-size: 1em; border-radius: 4px; background: var(--bg); color: var(--accent);}
#cleared[hidden] { display: none;}
@media (max-width: 600px) {
  .main {max-width: 98vw;}
}
::-webkit-scrollbar { width: 6px;}
::-webkit-scrollbar-thumb { background: #b0b5c0; border-radius: 4px;}
body.dark ::-webkit-scrollbar-thumb { background: #313b46;}
</style>
</head>
<body>
<div class="appbar">
  <h1>⏳ TODO Timer Dashboard</h1>
  <div>
    <button id="exportBtn" title="Export/Import">&#x1F4BE;</button>
    <button id="darkBtn" title="Toggle dark mode">&#9788;</button>
  </div>
</div>
<div class="main">
  <section>
    <div class="box-title">Recap</div>
  </section>
</div>
<div class="main">
  <section>
    <div class="box-title">Active</div>
    <div class="box active-box" id="active"></div>
  </section>
  <section>
    <div style="display:flex;align-items:center;justify-content:space-between;">
      <div class="box-title">TO DO List</div>
      <button id="cleared-tab-btn" type="button">Cleared</button>
    </div>
    <div class="box" id="list"></div>
    <div class="add-bar">
      <input id="addInput" type="text" placeholder="Add new task (#tag for tags, ! for priority)" autocomplete="off">
      <button id="addBtn" type="button">Add</button>
    </div>
  </section>
  <section id="cleared-section">
    <div class="box-title">Cleared</div>
    <div class="box" id="cleared"></div>
  </section>
</div>
<div class="main">
  <section>
    <div class="box-title">Details</div>
	<div class="box active-box" id="active"></div>
	<div class="box-title">Tags</div>
	<div class="box active-box" id="active"></div>
  </section>
</div>

<!-- Export/Import modal -->
<div id="exportModal" style="display:none; position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:99; background:#0008;">
  <div style="margin:8vh auto;max-width:400px;background:var(--box);color:var(--text);padding:2em 1.2em;border-radius:12px;box-shadow:0 4px 24px #0004;">
    <h2 style="margin-top:0;">Export / Import</h2>
    <textarea id="exportArea" rows="7" style="width:99%;background:var(--bg);color:var(--text);margin-bottom:1em;"></textarea>
    <div>
      <button onclick="importData()" style="background:var(--done);margin-right:1em;">Import</button>
      <button onclick="closeExportModal()">Close</button>
    </div>
    <div style="font-size:0.9em;opacity:0.7;margin-top:0.7em;">Copy & save for backup. Paste JSON to import.</div>
  </div>
</div>

<script>
// === Data Structures ===
const LS_KEY = 'todo-timer-list-v1';
let data = {
  tasks: [],        // {id, desc, tags, prio, done, active, timeSpent, lastStart, doneAt}
  order: {active: null, list: [], cleared: []}, // ids
  dark: false,
};
function save() {
  localStorage.setItem(LS_KEY, JSON.stringify(data));
}
function load() {
  let d = localStorage.getItem(LS_KEY);
  if (d) data = JSON.parse(d);
}
load();
if (!data.tasks) data = {tasks:[],order:{active:null,list:[],cleared:[]},dark:false};

function uuid() { return '_' + Math.random().toString(36).substr(2,9); }

// === Rendering ===
function render() {
  renderActive();
  renderList();
  renderCleared();
  document.body.classList.toggle('dark', !!data.dark);
}
function getTask(id) { return data.tasks.find(t => t.id === id); }

function renderActive() {
  const box = document.getElementById('active');
  box.innerHTML = '';
  if (data.order.active) {
    let t = getTask(data.order.active);
    box.appendChild(renderTodo(t, true));
  }
}

function renderList() {
  const box = document.getElementById('list');
  box.innerHTML = '';
  data.order.list.forEach(id => {
    let t = getTask(id);
    if (t) box.appendChild(renderTodo(t));
  });
}

function renderCleared() {
  const box = document.getElementById('cleared');
  box.innerHTML = '';
  data.order.cleared.forEach(id => {
    let t = getTask(id);
    if (t) box.appendChild(renderTodo(t, false, true));
  });
  // Show/hide cleared
  document.getElementById('cleared-section').hidden = !clearedShown;
}

function renderTodo(t, isActive, isCleared) {
  let div = document.createElement('div');
  div.className = 'todo' + (t.done ? ' done':'');
  div.setAttribute('data-id', t.id);
  div.setAttribute('data-prio', t.prio||'0');
  // Checkbox
  if (!isActive && !isCleared) {
    let cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.checked = !!t.done;
    cb.onclick = e => { markDone(t.id, cb.checked); };
    div.appendChild(cb);
  } else if (isCleared) {
    let cb = document.createElement('input');
    cb.type = 'checkbox'; cb.checked = true; cb.disabled = true;
    div.appendChild(cb);
  }
  // Priority dot
  let prio = document.createElement('span');
  prio.className = 'prio';
  prio.title = 'Click to change priority';
  prio.onclick = (e) => { cyclePrio(t.id); };
  div.appendChild(prio);
  // Desc & tags
  let descSpan = document.createElement('span');
  descSpan.className = 'desc';
  descSpan.textContent = t.desc;
  descSpan.ondblclick = () => editTask(t.id);
  div.appendChild(descSpan);
  // Tags
  let tags = document.createElement('span');
  tags.className = 'tags';
  t.tags.forEach(tag => {
    let tagEl = document.createElement('span');
    tagEl.className = 'tag'; tagEl.textContent = tag;
    tagEl.onclick = () => editTags(t.id);
    tags.appendChild(tagEl);
  });
  div.appendChild(tags);
  // Time
  let time = document.createElement('span');
  time.className = 'time';
  if (isActive) time.textContent = fmtTime(t.timeSpent + elapsedTime(t));
  else if (t.timeSpent) time.textContent = fmtTime(t.timeSpent);
  div.appendChild(time);
  // DoneAt (cleared)
  if (isCleared && t.doneAt) {
    let date = new Date(t.doneAt);
    let label = document.createElement('span');
    label.style.fontSize = '0.85em';
    label.style.opacity = '0.6';
    label.textContent = '✔ ' + date.toLocaleString();
    div.appendChild(label);
  }
  // Actions (edit/delete)
  let actions = document.createElement('span');
  actions.className = 'actions';
  if (!isCleared) {
    let edit = document.createElement('span');
    edit.className = 'edit'; edit.title = 'Edit';
    edit.innerHTML = '&#9998;';
    edit.onclick = () => editTask(t.id);
    actions.appendChild(edit);
  }
  if (isCleared) {
    let del = document.createElement('span');
    del.className = 'delete'; del.title = 'Delete';
    del.innerHTML = '&#128465;';
    del.onclick = () => { deleteTask(t.id); };
    actions.appendChild(del);
  }
  div.appendChild(actions);
  // Draggable
  if (!isCleared) {
    div.draggable = true;
    div.ondragstart = (e) => {
      e.dataTransfer.setData("id", t.id);
      e.dataTransfer.effectAllowed = "move";
    };
  }
  return div;
}
function fmtTime(sec) {
  sec = Math.floor(sec);
  let m = Math.floor(sec/60), s = sec%60;
  if (m < 60) return `${m}:${s.toString().padStart(2,'0')}`;
  let h = Math.floor(m/60); m = m%60;
  return `${h}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}
function elapsedTime(t) {
  if (t.active && t.lastStart) return (Date.now() - t.lastStart)/1000;
  return 0;
}

// === Timer Updates ===
setInterval(()=>{
  if (data.order.active) renderActive();
}, 1000);

// === Add/Edit/Tag ===
document.getElementById('addBtn').onclick = tryAddTask;
document.getElementById('addInput').addEventListener('keydown', e=>{
  if (e.key==='Enter') tryAddTask();
});
function parseTaskInput(val) {
  let desc = val, tags = [], prio = 0;
  let tagMatch = val.match(/#([a-zA-Z0-9_\-]+)/g);
  if (tagMatch) {
    tags = tagMatch.map(t=>t.replace('#',''));
    desc = desc.replace(/#[a-zA-Z0-9_\-]+/g, '').trim();
  }
  if (desc.match(/!{2,}/)) prio = 3;
  else if (desc.match(/!/)) prio = 2;
  desc = desc.replace(/!+/g,'').trim();
  return {desc, tags, prio};
}
function tryAddTask() {
  let val = document.getElementById('addInput').value.trim();
  if (!val) return;
  let {desc, tags, prio} = parseTaskInput(val);
  let t = {
    id: uuid(),
    desc: desc,
    tags: tags,
    prio: prio,
    done: false,
    active: false,
    timeSpent: 0,
    lastStart: null,
    doneAt: null,
  };
  data.tasks.push(t);
  data.order.list.push(t.id);
  document.getElementById('addInput').value = '';
  save(); render();
}

function editTask(id) {
  let t = getTask(id);
  let div = document.querySelector('.todo[data-id="'+id+'"]');
  if (!t || !div) return;
  let input = document.createElement('input');
  input.type = 'text'; input.value = t.desc + (t.tags.length?' #'+t.tags.join(' #'):'');
  input.className = 'edit';
  input.onkeydown = e => {
    if (e.key==='Enter') { finish(); }
    else if (e.key==='Escape') { div.replaceWith(renderTodo(t, t.active, t.done)); }
  };
  input.onblur = finish;
  function finish() {
    let {desc, tags, prio} = parseTaskInput(input.value);
    t.desc = desc; t.tags = tags;
    if (prio) t.prio = prio;
    save(); render();
  }
  div.innerHTML = ''; div.appendChild(input);
  input.focus(); input.select();
}
function editTags(id) {
  let t = getTask(id);
  let tags = prompt('Edit tags (comma separated):', t.tags.join(','));
  if (tags !== null) {
    t.tags = tags.split(',').map(s=>s.trim()).filter(Boolean);
    save(); render();
  }
}
function cyclePrio(id) {
  let t = getTask(id);
  t.prio = (t.prio||0) + 1;
  if (t.prio>3) t.prio=0;
  save(); render();
}

// === Drag & Drop Logic ===
document.getElementById('list').ondragover = document.getElementById('active').ondragover = e=>{
  e.preventDefault();
};
document.getElementById('list').ondrop = e=>{
  let id = e.dataTransfer.getData("id");
  moveToList(id);
};
document.getElementById('active').ondrop = e=>{
  let id = e.dataTransfer.getData("id");
  moveToActive(id);
};
function moveToActive(id) {
  let t = getTask(id);
  if (!t || t.done) return;
  // Move out previous active
  if (data.order.active && data.order.active !== id) {
    moveToList(data.order.active);
  }
  // Remove from list if present
  data.order.list = data.order.list.filter(x=>x!==id);
  data.order.active = id;
  t.active = true;
  t.lastStart = Date.now();
  save(); render();
}
function moveToList(id) {
  let t = getTask(id);
  if (!t) return;
  if (data.order.active === id) {
    // Pause timer
    t.timeSpent += elapsedTime(t);
    t.active = false;
    t.lastStart = null;
    data.order.active = null;
  }
  if (!data.order.list.includes(id) && !t.done)
    data.order.list.push(id);
  save(); render();
}
// Done/cleared
function markDone(id, state) {
  let t = getTask(id);
  if (!t) return;
  if (state) {
    t.done = true;
    t.active = false;
    t.timeSpent += elapsedTime(t);
    t.lastStart = null;
    t.doneAt = Date.now();
    // Remove from everywhere
    data.order.active = data.order.active === id ? null : data.order.active;
    data.order.list = data.order.list.filter(x=>x!==id);
    data.order.cleared.unshift(id);
  } else {
    t.done = false;
    t.doneAt = null;
    data.order.cleared = data.order.cleared.filter(x=>x!==id);
    data.order.list.push(id);
  }
  save(); render();
}
function deleteTask(id) {
  // Remove everywhere
  data.tasks = data.tasks.filter(t=>t.id!==id);
  if (data.order.active === id) data.order.active = null;
  data.order.list = data.order.list.filter(x=>x!==id);
  data.order.cleared = data.order.cleared.filter(x=>x!==id);
  save(); render();
}

// === Cleared Tab Logic ===
let clearedShown = false;
document.getElementById('cleared-tab-btn').onclick = ()=>{
  clearedShown = !clearedShown;
  renderCleared();
  document.getElementById('cleared-tab-btn').textContent = clearedShown ? "Hide Cleared" : "Cleared";
};

// === Dark Mode ===
document.getElementById('darkBtn').onclick = ()=>{
  data.dark = !data.dark; save(); render();
};
if(data.dark) document.body.classList.add('dark');

// === Export/Import ===
document.getElementById('exportBtn').onclick = ()=>{
  document.getElementById('exportModal').style.display = '';
  document.getElementById('exportArea').value = JSON.stringify(data,null,2);
};
function closeExportModal() {
  document.getElementById('exportModal').style.display = 'none';
}
function importData() {
  if (confirm("Importing will overwrite all current tasks. Proceed?")) {
    try {
      let obj = JSON.parse(document.getElementById('exportArea').value);
      if(obj && obj.tasks && obj.order) {
        data = obj;
        save(); render(); closeExportModal();
      } else alert("Invalid data.");
    } catch(e) { alert("Error: Invalid JSON"); }
  }
}
document.getElementById('exportModal').onclick = function(e) {
  if (e.target===this) closeExportModal();
};

// Initial render
render();
</script>
</body>
</html>
